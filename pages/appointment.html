<!--This is not a independent page-->
<!--It will be add in to a <div> element-->
<!--no need to start with <!DOCTYPE html> <html> <head> <body> tags-->
<style>
    .appointment-page {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px;
        height: 100%;
    }

    .appointment-page h1 {
        font-size: 36px;
        margin-bottom: 20px;
        text-align: center;
    }
    /* 這裡省略其他的 form-default-style CSS，確保您的網站有定義 .form-label, .form-input 等樣式 */
</style>
<div class="appointment-page usingFormDefaultStyle">
    <div class="form-container">
        <h1 id="form-title">Service Booking And Online Quotation</h1>
        <form id="appointment-form" method="get" class="usingFormDefaultStyle">
            <div class="form-input-group">
                <label class="form-label" for="service-type">Select a service</label>
                <select class="form-select" id="service-type" name="service-type" disabled required>
                    <option>Loading service types...</option>
                </select>
            </div>
            <!-- Dyanimc Generated Fields -->
            <div id="form-fields"></div>

            <input type="submit" class="form-submit-button" value="Submit and Proceed to Payment">
        </form>
    </div>
</div>

<script>
    console.log('Appointment page script loaded');
    const container = document.getElementById('form-fields');
    const serviceSelect = document.getElementById('service-type');

    function loadServiceOptions(serviceType, datas) {
        const config = datas[serviceType];
        if (!config) {
            container.innerHTML = '<p>找不到對應的服務設定。</p>';
            return;
        }

        // Set title
        document.getElementById('form-title').textContent = config.title;

        // Dynamically generate fields
        container.innerHTML = '';
        config.form.fields.forEach(field => {
            let html = '';
            if (field.type === 'select') {
                // 使用 option 的 label 作為 value，並儲存 price 和 discount 到 data 屬性
                html = `<label class="form-label" for="${field.name}">${field.label}</label>
                        <select class="form-select" id="${field.name}" name="${field.name}" ${field.required ? 'required' : ''}>
                            ${config[field.options].map(opt => {
                                opt.price = opt.price || 0;
                                opt.discount_percent = Math.max(0,Math.min(100, opt.discount_percent || 100));
                                const savePercent = 100 - opt.discount_percent;
                                let final_price = opt.price;
                                if (opt.price != '聯繫報價')  final_price = (opt.price * (opt.discount_percent / 100)).toFixed(2);
                                const price_label = opt.price == '聯繫報價' ? '聯繫報價' : (opt.discount_percent < 100 ? `HKD $${final_price} (原價 HKD $${opt.price}, 節省 ${savePercent}%)` : `HKD $${opt.price}`);
                                return `
                                <option value="${opt.name}" 
                                    data-final-price="${final_price}"
                                    data-price="${opt.price}" 
                                    data-discount="${opt.discount_percent}"
                                >
                                    ${opt.name} -- ${price_label}
                                </option>`
                            }).join('')}
                        </select>`;
            } else if (field.type === 'textarea') {
                html = `<label class="form-label" for="${field.name}">${field.label}</label>
                        <textarea class="form-textarea" cols="${field.cols || ''}" rows="${field.rows || ''}" placeholder="${field.placeholder}" id="${field.name}" name="${field.name}"></textarea>`;
            } else {
                html = `<label class="form-label" for="${field.name}">${field.label}</label>
                        <input type="${field.type}" placeholder="${field.placeholder}" class="form-input" id="${field.name}" name="${field.name}" ${field.required ? 'required' : ''} min="${field.min || ''}">`;
            }
            const div = document.createElement('div');
            div.className = 'form-input-group';
            div.innerHTML = html;
            container.appendChild(div);
        });
    }

    let datas = null
    fetch('./json/services_form.json') 
    .then(res => res.json())
    .then(data => {
        datas = data;
        console.log('Service form data loaded:', data);
        const allKeys = Object.keys(data);
        serviceSelect.innerHTML = `
            <option value="" disabled selected>Select a service</option>
        `;

        allKeys.forEach(service => {
            const option = document.createElement('option');
            option.value = service;
            option.textContent = service.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            serviceSelect.appendChild(option);
        });
        serviceSelect.disabled = false;
    })
    .catch(err => {
        console.error('Error fetching service form data:', err);
        container.innerHTML = '<p>無法載入服務設定，請稍後再試。</p>';
    })
    .then(() => {
    const hash = window.location.hash;
    let serviceType = null; // 儲存當前是哪種服務 (e.g., 'car-inspection')
    let hashash = false;
    if (hash.includes('?')) {
        const params = new URLSearchParams(hash.split('?')[1]);
        serviceType = params.get('service');
        if (serviceType) {
            loadServiceOptions(serviceType, datas);
            serviceSelect.value = serviceType;
            hashash = true;
        }
    }
    if (!hashash) { 
        container.innerHTML = '<p>請從上方下拉選單選擇服務類型。</p>';
    }
    serviceSelect.addEventListener('change', (event) => {
        serviceType = event.target.value;
        loadServiceOptions(serviceType, datas);
    });

    // 電話號碼驗證邏輯 (使用正則表達式)
    const telInput = document.getElementById('phone');
    if (telInput) {
        telInput.addEventListener('input', () => {
            // 簡單檢查香港電話號碼格式: +852 開頭，後面 8 位數字
            const hkPhoneRegex = /^\+852\s?[4-9]\d{3}( )?\d{4}$/; 
            if (hkPhoneRegex.test(telInput.value.trim())) {
                telInput.setCustomValidity('');
            } else {
                telInput.setCustomValidity('無效的電話號碼。請輸入有效的香港電話號碼 (+852 xxxx xxxx), 電話號碼第一個數字必須是4至9。');
            }
            telInput.reportValidity();
        });
    }

    });
</script>
<script>
    function doubleCheckAndSave(form) {
        console.log('Form submission triggered');
        const formData = new FormData(form);
        const entries = Array.from(formData.entries());
        let allValid = true;
        
        // 基本驗證
        console.log('Starting basic validation');
        entries.forEach(([key, value]) => {
            if (!value.trim()) {
                alert(`請填寫所有必填欄位: ${key}`);
                allValid = false;
            }
            if (key.toLowerCase().includes('email')) {
                // 簡單 Email 格式檢查
                const emailRegex = /\S+@\S+\.\S+/;
                if (!emailRegex.test(value.trim())) {
                    alert("無效的 Email 地址。請輸入有效的 Email 地址。");
                    allValid = false;
                }
            }
        });
        if (!allValid) return false;

        console.log('Basic validation passed');

        // 價格計算與確認
        let totalAmount = 0;

        console.log('Calculating price and preparing confirmation message');
        // 找到 Select 欄位的選項，計算價格
        const serviceSelectElement = form.querySelector('select[data-price="true"]');
        
        if (serviceSelectElement) {
            const selectedOption = serviceSelectElement.options[serviceSelectElement.selectedIndex];
            const finalPrice = selectedOption.getAttribute('data-final-price');
            const price = selectedOption.getAttribute('data-price');
            const discount = selectedOption.getAttribute('data-discount');

            if (finalPrice === '聯繫報價') {
                 alert("您選擇的服務需要聯繫我們獲取報價，請等待我們的確認電話。");
                 totalAmount = null; 
            } else {
                totalAmount = parseFloat(finalPrice);
            }
        }
        console.log('Preparing confirmation message');
        // 確認信息
        let confirmationMessage = "請確認您的預約信息是否正確:\n\n";
        const newEntries = entries.map(([key,value]) => [key.charAt(0).toUpperCase() + key.slice(1), value]);
        newEntries.forEach(([key, value]) => {
             confirmationMessage += `${key}: ${value}\n`;
        });

        if (totalAmount > 0) {
            confirmationMessage += `\n預計總金額: HKD $${totalAmount.toFixed(2)}`;
        }
        
        const confirmation = confirm(confirmationMessage);
        if (!confirmation) {
            return false;
        }

        // 儲存到 sessionStorage 並跳轉 (保留了原有的 sessionStorage 邏輯)
        alert("感謝您的預約！即將跳轉到付款頁面。");
        sessionStorage.clear();
        newEntries.forEach(([key, value]) => {
            sessionStorage.setItem(key, value);
        });
        
        // 儲存最終價格，方便支付頁面使用
        sessionStorage.setItem('FinalAmount', totalAmount == null ? '聯繫報價' : totalAmount.toFixed(2));
        const keys = newEntries.map(([key]) => key);
        keys.push('FinalAmount');
        console.log(keys.toString());
        sessionStorage.setItem('submittedItems', keys.toString());

        window.location.hash = "#payment";
        return false; 
    }
    // Sart script execution
    const appointmentForm = document.getElementById('appointment-form');
    appointmentForm.addEventListener('submit', (event) => {
        event.preventDefault(); // Prevent form submission if validation fails
        doubleCheckAndSave(appointmentForm);
    });
</script>
